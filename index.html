<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>×¡×˜×•×“×™×• ×¦×™×•×¨ ×œ×™×œ×“×™×</title>
  <style>
    :root{--bg:#f6f8ff;--line:#dbe3ff;--ink:#1f2937;--accent:#5b5bd6}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Segoe UI",Arial,sans-serif;color:var(--ink);background:linear-gradient(130deg,#dbeafe,#f5d0fe 55%,#fef3c7);min-height:100vh}
    .app{max-width:1200px;margin:0 auto;background:#ffffffd9;backdrop-filter:blur(2px);min-height:100vh;display:grid;grid-template-rows:auto 1fr}
    .top{padding:10px;border-bottom:1px solid var(--line);background:var(--bg);display:grid;gap:8px}
    .status{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .challenge{background:#eef2ff;border:1px solid #c7d2fe;border-radius:10px;padding:7px;font-weight:700;color:#3730a3;flex:1;min-width:220px}
    .score{font-weight:800;color:#0f766e}
    .layout{display:grid;grid-template-columns:1fr 320px;gap:10px;padding:10px}
    .board-box{border:2px dashed #93c5fd;border-radius:14px;background:#fff;overflow:hidden;display:grid;place-items:center;min-height:520px}
    .board-stack{position:relative;width:min(100%,920px);aspect-ratio:16/10}
    .board-stack canvas{position:absolute;inset:0;width:100%;height:100%;display:block;touch-action:none}
    #templateLayer{pointer-events:none;background:transparent}
    #board{background:#fff}
    .controls{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;display:grid;gap:8px;align-content:start}
    .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    button,select,input[type="range"],input[type="color"]{border:1px solid #cbd5e1;border-radius:10px;background:#fff;padding:8px 10px;font-size:14px}
    button{cursor:pointer;font-weight:600}
    button.active{outline:3px solid #11182722}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .swatch{width:30px;height:30px;border-radius:999px;padding:0;border:2px solid #fff;box-shadow:0 0 0 1px #cbd5e1}
    .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}
    .hint{font-size:12px;color:#6b7280}
    details{border:1px solid var(--line);border-radius:10px;padding:6px;background:#fafbff}
    summary{cursor:pointer;font-weight:700}

    @media (max-width:900px){
      .layout{grid-template-columns:1fr;padding:8px}
      .controls{position:fixed;left:8px;right:8px;bottom:calc(env(safe-area-inset-bottom) + 8px);z-index:50;box-shadow:0 12px 30px rgba(0,0,0,.2);padding:8px;max-height:45vh;overflow:auto}
      .board-box{min-height:48vh;margin-bottom:220px}
      .mobile-tools{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px}
      .mobile-tools button{padding:10px 6px;font-size:13px}
      .top{position:sticky;top:0;z-index:40}
    }
    @media (min-width:901px){ .mobile-tools{display:none} }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="status">
        <div class="challenge" id="challenge">××©×™××”: ×¦×™×™×¨×™ ×’×Ÿ ×©×¢×©×•×¢×™× ğŸ </div>
        <button id="newChallenge" class="primary">××©×™××” ×—×“×©×”</button>
        <div class="score">×›×•×›×‘×™×: <span id="stars">0</span> â­</div>
      </div>
    </div>

    <div class="layout">
      <div class="board-box">
        <div class="board-stack">
          <canvas id="board" width="960" height="600"></canvas>
          <canvas id="templateLayer" width="960" height="600"></canvas>
        </div>
      </div>

      <aside class="controls">
        <div class="mobile-tools">
          <button id="m-pen">âœï¸ ×˜×•×©</button>
          <button id="m-eraser">ğŸ§½ ××—×§</button>
          <button id="m-fill">ğŸª£ ××™×œ×•×™</button>
          <button id="m-shapes">ğŸ“ ×¦×•×¨×•×ª</button>
          <button id="m-undo">â†©ï¸ ×‘×˜×œ</button>
          <button id="m-redo">â†ªï¸ ×”×—×–×¨</button>
          <button id="m-save">ğŸ’¾ ×©××•×¨</button>
          <button id="m-more">âš™ï¸ ××ª×§×“×</button>
        </div>

        <details id="advancedPanel" open>
          <summary>×›×œ×™× ×•×”×’×“×¨×•×ª</summary>

          <div class="row" style="margin-top:8px">
            <button id="tool-pen" class="active">âœï¸ ×˜×•×©</button>
            <button id="tool-eraser">ğŸ§½ ××—×§</button>
            <button id="tool-fill">ğŸª£ ××™×œ×•×™</button>
            <button id="tool-line">ğŸ“ ×§×•</button>
            <button id="tool-rect">â¬› ××œ×‘×Ÿ</button>
            <button id="tool-circle">â­• ×¢×™×’×•×œ</button>
            <button id="undo">â†©ï¸</button>
            <button id="redo">â†ªï¸</button>
          </div>

          <div class="row" style="margin-top:8px">
            <button class="swatch" data-color="#ef4444" style="background:#ef4444"></button>
            <button class="swatch" data-color="#f59e0b" style="background:#f59e0b"></button>
            <button class="swatch" data-color="#22c55e" style="background:#22c55e"></button>
            <button class="swatch" data-color="#3b82f6" style="background:#3b82f6"></button>
            <button class="swatch" data-color="#a855f7" style="background:#a855f7"></button>
            <button class="swatch" data-color="#111827" style="background:#111827"></button>
            <input id="customColor" type="color" value="#ef4444" />
            <input id="size" type="range" min="2" max="40" value="7" />
          </div>

          <div class="row" style="margin-top:8px">
            <label>×¨×§×¢</label>
            <select id="background"><option value="white">×œ×‘×Ÿ</option><option value="sky">×©××™×™×</option><option value="grass">×“×©×</option><option value="sunset">×©×§×™×¢×”</option></select>
            <label>×“×£ ×¦×‘×™×¢×”</label>
            <select id="templateSelect"><option value="none">×‘×œ×™ ×ª×‘× ×™×ª</option><option value="house">×‘×™×ª</option><option value="cat">×—×ª×•×œ</option><option value="butterfly">×¤×¨×¤×¨</option><option value="rocket">×—×œ×œ×™×ª</option></select>
            <button id="loadTemplate">×”×¦×’ ×ª×‘× ×™×ª</button>
          </div>

          <div class="row" style="margin-top:8px">
            <button id="stamp-star">â­</button>
            <button id="stamp-heart">ğŸ’–</button>
            <button id="stamp-flower">ğŸŒ¸</button>
            <button id="stamp-smile">ğŸ˜€</button>
            <button id="clear">× ×§×”</button>
            <button id="save" class="primary">×©××•×¨ ×¦×™×•×¨</button>
          </div>

          <details style="margin-top:8px">
            <summary>×“×•-×§×¨×‘ 2 ×©×—×§× ×™×</summary>
            <div class="row" style="margin-top:8px">ğŸ® ××¦×‘: <span id="duelStatus">×›×‘×•×™</span></div>
            <div class="row">×©×—×§×Ÿ: <span id="duelPlayer">-</span> | ×–××Ÿ: <span id="duelTime">0</span> ×©× '</div>
            <div class="row">× ×™×§×•×“: 1=<span id="p1">0</span> | 2=<span id="p2">0</span></div>
            <button id="startDuel">×”×ª×—×œ ×“×•-×§×¨×‘ (60 ×©× ×³ ×œ×›×œ ×©×—×§×Ÿ)</button>
          </details>

          <div class="row" style="margin-top:8px"><b>×’×œ×¨×™×”</b></div>
          <div id="gallery" class="cards"></div>
          <div class="hint">×“×¤×™ ×¦×‘×™×¢×” × ×˜×¢× ×™× ×‘×©×›×‘×” × ×¤×¨×“×ª â€” ××™ ××¤×©×¨ ×œ××—×•×§ ××ª ×§×•×•×™ ×”××ª××¨ ×©×œ×”×.</div>
        </details>
      </aside>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('board');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const templateCanvas = document.getElementById('templateLayer');
    const tctx = templateCanvas.getContext('2d');

    const starsEl = document.getElementById('stars');
    const challengeEl = document.getElementById('challenge');
    const galleryEl = document.getElementById('gallery');
    const advancedPanel = document.getElementById('advancedPanel');

    const duelStatusEl = document.getElementById('duelStatus');
    const duelPlayerEl = document.getElementById('duelPlayer');
    const duelTimeEl = document.getElementById('duelTime');
    const p1El = document.getElementById('p1');
    const p2El = document.getElementById('p2');

    const challenges = ['×¦×™×™×¨×™ ×’×Ÿ ×©×¢×©×•×¢×™× ğŸ ','×¦×™×™×¨×™ × ×¡×™×›×” ×•×›×ª×¨ ğŸ‘‘','×¦×™×™×¨×™ ×“×™× ×•×–××•×¨ ×™×“×™×“×•×ª×™ ğŸ¦•','×¦×™×™×¨×™ ××¨××•×Ÿ ×§×¡×•× ğŸ°','×¦×™×™×¨×™ ×—×œ×œ ×¢× ×›×•×›×‘×™× ğŸš€','×¦×™×™×¨×™ ×—×“Ö¾×§×¨×Ÿ ğŸ¦„','×¦×™×™×¨×™ ×—×•×£ ×™× ×§×™×¦×™ ğŸ–ï¸'];

    let color='#ef4444', brush=7, drawing=false, tool='pen', stars=0, stampMode=null;
    let startPoint=null, shapeSnapshot=null, lastPos=null;
    const history=[], future=[];
    const duel={active:false,player:1,timeLeft:0,timer:null,scores:[0,0,0]};

    function awardStars(n){ stars+=n; starsEl.textContent=stars; if(duel.active){ duel.scores[duel.player]+=n; p1El.textContent=duel.scores[1]; p2El.textContent=duel.scores[2]; }}
    function pushHistory(){ history.push(canvas.toDataURL('image/png')); if(history.length>25)history.shift(); future.length=0; }
    function restoreFrom(dataUrl){ const img=new Image(); img.onload=()=>{ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(img,0,0,canvas.width,canvas.height)}; img.src=dataUrl; }
    function setBackground(kind){ const g={white:'#fff',sky:'#e0f2fe',grass:'#dcfce7',sunset:'#fde68a'}[kind]||'#fff'; ctx.save();ctx.globalCompositeOperation='destination-over';ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.restore(); }
    function getPos(e){ const r=canvas.getBoundingClientRect(); return {x:Math.round((e.clientX-r.left)*(canvas.width/r.width)), y:Math.round((e.clientY-r.top)*(canvas.height/r.height))}; }

    function startDraw(e){
      e.preventDefault();
      const p=getPos(e); lastPos=p;

      if(stampMode){ pushHistory(); drawStamp(stampMode,p.x,p.y); stampMode=null; return; }
      if(tool==='fill'){ pushHistory(); floodFill(p.x,p.y,hexToRgba(color)); awardStars(1); return; }

      drawing=true;
      pushHistory();
      startPoint=p;

      if(['line','rect','circle'].includes(tool)) shapeSnapshot=ctx.getImageData(0,0,canvas.width,canvas.height);
      else { ctx.beginPath(); ctx.moveTo(p.x,p.y); }
    }

    function draw(e){
      if(!drawing) return;
      e.preventDefault();
      const p=getPos(e); lastPos=p;
      ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=brush;

      if(tool==='pen' || tool==='eraser'){
        ctx.strokeStyle = tool==='eraser' ? '#ffffff' : color;
        ctx.lineTo(p.x,p.y); ctx.stroke();
        return;
      }

      if(['line','rect','circle'].includes(tool)){
        ctx.putImageData(shapeSnapshot,0,0);
        ctx.strokeStyle=color;
        drawShapePreview(startPoint,p,tool);
      }
    }

    function endDraw(e){
      if(!drawing) return;
      const p = e ? getPos(e) : lastPos;
      if(['line','rect','circle'].includes(tool) && p){
        ctx.putImageData(shapeSnapshot,0,0);
        ctx.strokeStyle=color;
        drawShapePreview(startPoint,p,tool);
      }
      drawing=false; startPoint=null; shapeSnapshot=null; awardStars(1);
    }

    function drawShapePreview(a,b,shape){
      if(shape==='line'){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); }
      else if(shape==='rect'){ ctx.strokeRect(a.x,a.y,b.x-a.x,b.y-a.y); }
      else if(shape==='circle'){ const r=Math.hypot(b.x-a.x,b.y-a.y); ctx.beginPath(); ctx.arc(a.x,a.y,r,0,Math.PI*2); ctx.stroke(); }
    }

    function setTool(next){ tool=next; stampMode=null; document.querySelectorAll('[id^="tool-"]').forEach(b=>b.classList.remove('active')); const el=document.getElementById(`tool-${next}`); if(el)el.classList.add('active'); }

    function drawStamp(type,x,y){
      ctx.save(); ctx.fillStyle=color; ctx.strokeStyle=color; ctx.lineWidth=3;
      if(type==='star'){ const spikes=5,outer=28,inner=12; let rot=Math.PI/2*3; ctx.beginPath(); ctx.moveTo(x,y-outer); for(let i=0;i<spikes;i++){ ctx.lineTo(x+Math.cos(rot)*outer,y+Math.sin(rot)*outer); rot+=Math.PI/spikes; ctx.lineTo(x+Math.cos(rot)*inner,y+Math.sin(rot)*inner); rot+=Math.PI/spikes; } ctx.closePath(); ctx.fill(); }
      if(type==='heart'){ ctx.beginPath(); ctx.moveTo(x,y+12); ctx.bezierCurveTo(x-30,y-18,x-55,y+24,x,y+52); ctx.bezierCurveTo(x+55,y+24,x+30,y-18,x,y+12); ctx.fill(); }
      if(type==='flower'){ for(let i=0;i<6;i++){ const a=(Math.PI*2/6)*i; ctx.beginPath(); ctx.arc(x+Math.cos(a)*22,y+Math.sin(a)*22,13,0,Math.PI*2); ctx.fill(); } ctx.fillStyle='#facc15'; ctx.beginPath(); ctx.arc(x,y,12,0,Math.PI*2); ctx.fill(); }
      if(type==='smile'){ ctx.fillStyle='#fde047'; ctx.beginPath(); ctx.arc(x,y,30,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#111827'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(x-10,y-8,3,0,Math.PI*2); ctx.arc(x+10,y-8,3,0,Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(x,y+2,14,0,Math.PI); ctx.stroke(); }
      ctx.restore(); awardStars(1);
    }

    function clearTemplate(){ tctx.clearRect(0,0,templateCanvas.width,templateCanvas.height); }

    function drawTemplate(name){
      clearTemplate();
      tctx.strokeStyle='#111827'; tctx.lineWidth=4; tctx.lineJoin='round'; tctx.lineCap='round';

      if(name==='house'){ tctx.strokeRect(300,250,360,230); tctx.beginPath(); tctx.moveTo(280,250); tctx.lineTo(480,120); tctx.lineTo(680,250); tctx.stroke(); tctx.strokeRect(445,360,70,120); tctx.strokeRect(355,300,70,60); tctx.strokeRect(535,300,70,60); }
      if(name==='cat'){ tctx.beginPath(); tctx.arc(480,320,130,0,Math.PI*2); tctx.stroke(); tctx.beginPath(); tctx.moveTo(390,220); tctx.lineTo(430,130); tctx.lineTo(470,220); tctx.moveTo(490,220); tctx.lineTo(530,130); tctx.lineTo(570,220); tctx.stroke(); tctx.beginPath(); tctx.arc(435,305,12,0,Math.PI*2); tctx.arc(525,305,12,0,Math.PI*2); tctx.stroke(); tctx.beginPath(); tctx.arc(480,350,16,0,Math.PI*2); tctx.stroke(); }
      if(name==='butterfly'){ tctx.beginPath(); tctx.ellipse(410,320,110,140,0.6,0,Math.PI*2); tctx.ellipse(550,320,110,140,-0.6,0,Math.PI*2); tctx.stroke(); tctx.beginPath(); tctx.moveTo(480,170); tctx.lineTo(480,470); tctx.stroke(); }
      if(name==='rocket'){ tctx.beginPath(); tctx.moveTo(480,120); tctx.lineTo(570,270); tctx.lineTo(570,450); tctx.lineTo(390,450); tctx.lineTo(390,270); tctx.closePath(); tctx.stroke(); tctx.beginPath(); tctx.arc(480,280,45,0,Math.PI*2); tctx.stroke(); tctx.beginPath(); tctx.moveTo(390,420); tctx.lineTo(320,470); tctx.lineTo(390,470); tctx.stroke(); tctx.beginPath(); tctx.moveTo(570,420); tctx.lineTo(640,470); tctx.lineTo(570,470); tctx.stroke(); }

      if(name!=='none') awardStars(2);
    }

    function hexToRgba(hex){ const h=hex.replace('#',''); return [parseInt(h.substring(0,2),16),parseInt(h.substring(2,4),16),parseInt(h.substring(4,6),16),255]; }
    function floodFill(x,y,newColor){ const img=ctx.getImageData(0,0,canvas.width,canvas.height),d=img.data; const idx=(y*canvas.width+x)*4; const target=[d[idx],d[idx+1],d[idx+2],d[idx+3]]; if(target.every((v,i)=>v===newColor[i])) return; const stack=[[x,y]], match=i=>d[i]===target[0]&&d[i+1]===target[1]&&d[i+2]===target[2]&&d[i+3]===target[3]; while(stack.length){ const [cx,cy]=stack.pop(); if(cx<0||cy<0||cx>=canvas.width||cy>=canvas.height) continue; const i=(cy*canvas.width+cx)*4; if(!match(i)) continue; d[i]=newColor[0]; d[i+1]=newColor[1]; d[i+2]=newColor[2]; d[i+3]=newColor[3]; stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]); } ctx.putImageData(img,0,0); }
    function saveToGallery(dataUrl){ const btn=document.createElement('button'); btn.textContent=`×¦×™×•×¨ ${galleryEl.children.length+1}`; btn.onclick=()=>restoreFrom(dataUrl); galleryEl.prepend(btn); if(galleryEl.children.length>8) galleryEl.removeChild(galleryEl.lastChild); }

    function updateDuelUI(){ duelStatusEl.textContent=duel.active?'×¤×¢×™×œ':'×›×‘×•×™'; duelPlayerEl.textContent=duel.active?`×©×—×§×Ÿ ${duel.player}`:'-'; duelTimeEl.textContent=duel.timeLeft; p1El.textContent=duel.scores[1]; p2El.textContent=duel.scores[2]; }
    function stopDuel(msg){ clearInterval(duel.timer); duel.active=false; duel.timeLeft=0; updateDuelUI(); if(msg) setTimeout(()=>alert(msg),30); }
    function switchTurn(){ if(duel.player===1){ duel.player=2; duel.timeLeft=60; ctx.clearRect(0,0,canvas.width,canvas.height); setTimeout(()=>alert('×ª×•×¨ ×©×—×§×Ÿ 2!'),30); } else { const w=duel.scores[1]===duel.scores[2]?'×ª×™×§×•!':(duel.scores[1]>duel.scores[2]?'×©×—×§×Ÿ 1 × ×™×¦×—! ğŸ†':'×©×—×§×Ÿ 2 × ×™×¦×—! ğŸ†'); stopDuel(`×”×“×•-×§×¨×‘ × ×’××¨! ${w}`); } updateDuelUI(); }
    function startDuel(){ clearInterval(duel.timer); duel.active=true; duel.player=1; duel.timeLeft=60; duel.scores=[0,0,0]; updateDuelUI(); ctx.clearRect(0,0,canvas.width,canvas.height); duel.timer=setInterval(()=>{ duel.timeLeft--; if(duel.timeLeft<=0) switchTurn(); updateDuelUI(); },1000); alert('×”×ª×—×œ× ×•! ×©×—×§×Ÿ 1 ××¦×™×™×¨ ×¢×›×©×™×•.'); }

    // Pointer events = better desktop + mobile reliability
    canvas.addEventListener('pointerdown', (e)=>{ canvas.setPointerCapture(e.pointerId); startDraw(e); });
    canvas.addEventListener('pointermove', draw);
    canvas.addEventListener('pointerup', endDraw);
    canvas.addEventListener('pointercancel', endDraw);

    ['pen','eraser','fill','line','rect','circle'].forEach(t=>{ const el=document.getElementById(`tool-${t}`); if(el) el.onclick=()=>setTool(t); });

    document.getElementById('undo').onclick=()=>{ if(!history.length) return; future.push(canvas.toDataURL('image/png')); restoreFrom(history.pop()); };
    document.getElementById('redo').onclick=()=>{ if(!future.length) return; history.push(canvas.toDataURL('image/png')); restoreFrom(future.pop()); };
    document.querySelectorAll('.swatch').forEach((btn,i)=>{ if(i===0) btn.classList.add('active'); btn.onclick=()=>{ document.querySelectorAll('.swatch').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); color=btn.dataset.color; document.getElementById('customColor').value=color; }; });
    document.getElementById('customColor').oninput=e=>{ color=e.target.value; document.querySelectorAll('.swatch').forEach(b=>b.classList.remove('active')); };
    document.getElementById('size').oninput=e=>brush=Number(e.target.value);
    document.getElementById('background').onchange=e=>{ pushHistory(); setBackground(e.target.value); };
    document.getElementById('loadTemplate').onclick=()=>drawTemplate(document.getElementById('templateSelect').value);

    document.getElementById('stamp-star').onclick=()=>stampMode='star';
    document.getElementById('stamp-heart').onclick=()=>stampMode='heart';
    document.getElementById('stamp-flower').onclick=()=>stampMode='flower';
    document.getElementById('stamp-smile').onclick=()=>stampMode='smile';

    document.getElementById('clear').onclick=()=>{ pushHistory(); ctx.clearRect(0,0,canvas.width,canvas.height); awardStars(1); };
    document.getElementById('newChallenge').onclick=()=>{ challengeEl.textContent='××©×™××”: '+challenges[Math.floor(Math.random()*challenges.length)]; awardStars(1); };
    document.getElementById('save').onclick=()=>{ const dataUrl=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=dataUrl; a.download=`kid-drawing-${Date.now()}.png`; a.click(); saveToGallery(dataUrl); awardStars(3); };
    document.getElementById('startDuel').onclick=startDuel;

    // Mobile shortcuts
    document.getElementById('m-pen').onclick=()=>setTool('pen');
    document.getElementById('m-eraser').onclick=()=>setTool('eraser');
    document.getElementById('m-fill').onclick=()=>setTool('fill');
    document.getElementById('m-shapes').onclick=()=>{ setTool('line'); advancedPanel.open=true; };
    document.getElementById('m-undo').onclick=()=>document.getElementById('undo').click();
    document.getElementById('m-redo').onclick=()=>document.getElementById('redo').click();
    document.getElementById('m-save').onclick=()=>document.getElementById('save').click();
    document.getElementById('m-more').onclick=()=>advancedPanel.open=!advancedPanel.open;

    setBackground('white');
    updateDuelUI();
  </script>
</body>
</html>
